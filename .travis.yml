git:
  depth: false
os: osx
osx_image: xcode11
script: bash clovergit --travis

before_script:
  - git config --global user.email "$GIT_EMAIL"
  - git config --global user.name "$GIT_NAME"
  - mkdir -p ~/src/tools
  - cp -R .Scripts ~/src/tools/Scripts

after_script:
  - git config credential.helper "store --file=.git/credentials"
  - echo "https://${GH_TOKEN}:@github.com" > .git/credentials

before_deploy:
  - export CLOVER_REV=$(cat ~/src/CloverBootloader/vers.txt)
  - export CLOVER_HASH=$(git -C ~/src/CloverBootloader rev-parse --short HEAD)
  - |
    git fetch
    if [ $(git tag -l "${CLOVER_REV}-${CLOVER_HASH}") ]; then
      git tag -d "${CLOVER_REV}-${CLOVER_HASH}"
      git push --delete origin "${CLOVER_REV}-${CLOVER_HASH}"
    fi
    git pull origin master
    echo "${CLOVER_REV}-${CLOVER_HASH}" > .lastTag
    echo "$(date)" >> .lastTag
    git add .lastTag
    git commit -m "Travis build: ${CLOVER_REV}-${CLOVER_HASH}"
    git tag "${CLOVER_REV}-${CLOVER_HASH}"
    git push --tags https://${GIT_NAME}:${GH_TOKEN}@github.com/${GIT_NAME}/DailyClover.git
  - mkdir -p .build
  - cp -R ~/src/CloverBootloader/CloverPackage/sym/Clover_v*.zip .build/
  - cp -R ~/src/CloverBootloader/CloverPackage/sym/CloverISO*.tar.lzma .build/

deploy:
  provider: releases
  api_key:
    secure: "$GH_TOKEN"
  file:
    - ".build/*.zip"
    - ".build/*.tar.lzma"
  skip_cleanup: true
  overwrite: true
  on:
    tags: true
    repo: vectorsigma72/DailyClover

env:
  global:
  - secure: cFLxHNrKvALTJqCeyS48Tmfow485hgPrkCD80poqJnn+dWQunJz7sCwjjWzTlW9wjbaIyWDR2N5eAax0TK0GRXe2jK4Cn2zCdKkqIFZaYHN7EbTtUyG2JgUuy5eCG0E9PV7/zYXx2v7NEWk7Awe/879SyhCWMYJf96srbV1A65pvCjFrA04ZpucQ6NKOSoSPqr46kuUNPCV0NXh9Pq5rTDgds22BD8XRcPI5mE73cqELFd5Vw0Ds1WjONlRAW9NZCCFVVJhb5MYjkUMVCQzV0gG8klID1M7OcfFoAeQsc4P+GMMMUF6Z49N94Qj88PAtOe/bhRLSqZRgOgDyuf1OGVwK+9IytGZyyf+hY9winsF27kZGQv6PmkAOFD72qeetcVv83POseVandGiZvFxqM/KeWaYpwK2xdqaO9f2N+JDtynoBj1lhdg4sTnpzXW/7p69qn6wYPY8APIKiiRe5O+H2er8B+58DoQuQKrKin6iUkEQJsS37samrSK66xrFnpS8ahMmHVBhTEvOzsxeU0S50VxJ/xUjV5XTNQYiUKlAh6pjb39e1TDugwr6TZerX6Pf5slFOAsShbnFZOqgJzsrMFu61aGnGEc8m8GH7JlmC2j9xThgrVsuoG/n6gj0b158l/6KBecC9QvdD1awQkQNQMSnQTWpzs4IIS7/VIGM=
